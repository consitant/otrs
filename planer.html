<!DOCTYPE HTML>
<html lang="de" xml:lang="de" xmlns="http://www.w3.org/1999/xhtml">
<head>
  
    <title>RAD+ Online-Terminbuchung</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
    <meta charset="UTF-8" /> 

    <script src="js/jquery.min.js"></script>
   
    <script src="js/moment-with-locales.min.js"></script>
    <script>
        moment.locale( "de" );
    </script>
    
    <script src="js/jquery/jquery-ui-1.11.4/jquery-ui.min.js"></script>
    <script src="js/datepicker-de.js"></script>
    <link rel="stylesheet" type="text/css" href="js/jquery/jquery-ui-1.11.4/jquery-ui.min.css" />
    
    <!-- open core Hauptlogik rein -->
    <script src='js/opencore_logic.js'></script>    

    <!-- open core planer logic rein -->
    <script src='js/planer_logic.js'></script>  

    
    <!-- calendar-plugin https://github.com/wrick17/calendar-plugin 
        Monatsansicht
    -->
    <script src="js/calendar-plugin/calendar.js"></script>
    <link rel="stylesheet" href="js/calendar-plugin/style.css" />
    <link rel="stylesheet" href="js/calendar-plugin/theme.css" />
    <link rel="stylesheet" type="text/css" href="scss/main.css" />
    <link rel="stylesheet" type="text/css" href="scss/responsive.css" />

    <!-- Kalender Wochenansicht -->
    <!-- https://www.jqueryscript.net/time-clock/pick-hours-availability-calendar.html -->
    <link rel="stylesheet" href="./js/mark-your-calendar-main/css/mark-your-calendar.css" />
    <script src="./js/mark-your-calendar-main/js/mark-your-calendar.js"></script>
     
</head>
<body class="rp-theme-service rp-patientportal" onbeforeunload="pl_deSelectSugg();">

    
    
    
    <!-- Headerbar -->
    <div class="rp-headerbar">
        <div class="rp-headerbar__left">
            <button class="rp-icon rp-icon--md" title="Navigation" onclick="openNav()"><i class="icon-worklist"></i></button>
        </div>
        <div class="rp-headerbar__center">
            <!-- <a href="index.html"><img src="images/RADplus_Logo_negativ.png" alt="RAD+" class="rp-headerbar__logo" /></a> -->
            <img src="images/RADplus_Logo_negativ.png" alt="RAD+" class="rp-headerbar__logo" />
        </div>
        <div class="rp-headerbar__right">
            <a href="" class="rp-icon rp-icon--sm map-phoneHref" title="Praxis anrufen"><i class="fa fa-phone"></i><span class="rp-hide-sm rp-ml-10 map-phone"></span></a>
        </div>
    </div>

    <!-- Sidebar Nav -->
    <div id="sidenav" class="rp-sidenav">
        <a href="javascript:void(0)" class="rp-icon rp-icon--close" onclick="closeNav()"><i class="icon-close"></i></a>
        <a href="planer.html" class="rp-sidenav__item">
            <i class="rp-icon icon-calendar"></i>
            Online-Terminbuchung
        </a>
        <a href="" target="_blank" class="rp-sidenav__item map-urlImpressum">
            <i class="rp-icon icon-info"></i>
            Impressum
        </a>	
        <a href="" target="_blank" class="rp-sidenav__item map-urlDatenschutz">
            <i class="rp-icon icon-lock"></i>
            Datenschutz
        </a>	
    </div>

    <!-- Main Container -->
    <div id="main" class="rp-page-container rp-pl-0">

        <div class="rp-page">

            <div class="rp-header-wrapper">

                <h1 class="rp-mb-5">Online-Terminbuchung</h1>
                <p class="map-title"></p>

                <ul id="pl_stepButCont" class="rp-wizard">
                    <!-- TO DO DAVID: Klassen zuordnen
                        abgeschlossene/positiv validierte Steps -> .rp-success
                        fehlerhaft validierte Steps -> .rp-error 
                    -->
                    <li class="rp-active" id="pl_stepBut_1">
                        <a data-step="1" onclick="pl_showStep(this);" href="#step-1">1</a>
                    </li>
                    <li class="rp-disabled" id="pl_stepBut_2">
                        <a data-step="2" onclick="pl_showStep(this);" href="#step-2">2</a>
                    </li>
                    <li class="" id="pl_stepBut_3">
                        <a data-step="3" onclick="pl_showStep(this);" href="#step-3">3</a>
                    </li>
                    <li class="" id="pl_stepBut_4">
                        <a data-step="4" onclick="pl_showStep(this);" href="#step-4">4</a>
                    </li>
                    <li class="" id="pl_stepBut_5">
                        <a data-step="5" onclick="pl_showStep(this);" href="#step-5">5</a>
                    </li>
                </ul>
            </div>

            <!-- STEP 1: Untersuchungsdaten -->
            <section class="rp-wizard-content" id="step-1">
                <div class="rp-content-wrapper">

                    <div class="rp-row">
                        <div class="rp-col-12">

                            <div class="rp-headline-wrapper">
                                <h2>Untersuchungsdaten</h2>
                            </div>

                            <p class="rp-mb-20">Die notwendigen Angaben finden Sie auf Ihrem Überweisungsschein.</p>

                            
                            <p class="rp-mb-20">Manche Untersuchungen sind online nicht buchbar, da wir zur Terminvergabe spezielle Informationen zur Fragestellung benötigen. 
                                <br/>Sollten Sie Ihre Untersuchung nicht finden, kontaktieren Sie uns bitte telefonisch unter 
                                <i class="fa fa-phone"></i><span class="rp-ml-10 map-phone"></span>
                            </p>
                                                                       
                            
                            
                            <form autocomplete="off" class="rp-form rp-form--vertical">
                                <div class="rp-row">
                                    <div class="rp-col-6 rp-col-sm-12">
                                        <div class="rp-form__group">
                                            <label class="rp-form__label">Welcher Arzt hat Sie überwiesen?</label>
                                            <input id="pl_referrer" type="search" class="rp-form__data" placeholder="Bitte Namen des Zuweisers eintragen" />
                                            <!--
                                            <div class="rp-form__data-wrapper">    
                                                <input id="pl_referrer" type="search" class="rp-form__data" placeholder="Zuweiser auswählen" />
                                                <i class="rp-icon icon-search"></i>
                                            </div>
                                            -->
                                        </div>
                                        <div class="rp-form__group">
                                            <label class="rp-form__label" id="pl_vertragsartLbl">Wie sind Sie versichert?</label>
                                            <select id="pl_vertragsart" class="rp-form__data" required>
                                                <option value="" disabled selected>Vertragsart auswählen</option>
                                                <option value="Kasse">Kasse</option>
                                                <option value="Privat">Privat</option>
                                                <option value="BG">BG</option>
                                            </select>
                                        </div>
                                        
                                    </div>
                                    <div class="rp-col-6 rp-col-sm-12">
                                        <div class="rp-form__group">
                                            <label class="rp-form__label" id="pl_chooseExaLbl">Welche Untersuchung benötigen Sie?</label>
                                            <div class="rp-form__data-wrapper">
                                                <select id="pl_modSel" class="rp-form__data" onchange="modChanged(this);" required>
                                                    <option value="" disabled selected>Modalität auswählen</option>
                                                </select>
                                            </div>
                                            <div class="rp-form__data-wrapper">
                                                <select id="pl_organSel" class="rp-form__data" onchange="organChanged(this);" required>
                                                    <option value="" disabled selected>Körperregion auswählen</option>
                                                </select>
                                            </div>
                                            <div class="rp-form__data-wrapper">    
                                                <input type="search" class="rp-form__data" placeholder="Suchen" onkeyup="searchExas(this);" />
                                                <i class="rp-icon icon-search"></i>
                                            </div>
                                            
                                        </div>
                                        <p class="rp-mb-5" id="pl_lblChooseExa" style="display:none;">Wählen Sie eine Untersuchung aus:</p>
                                        <ul id="pl_exaList" class="rp-list rp-list--clickable" style="display: none;">
                                        </ul>
                                    </div>
                                    
                                    
                                    
                                    
                                    
                                </div>
                            </form>

                        </div>
                    </div>
                </div>

            </section>

            
            
            
            
            
            <!-- STEP 2: Persönliche Angaben -->
            <section class="rp-wizard-content" id="step-2">
                <div class="rp-content-wrapper">

                    <div class="rp-row">

                        <div class="rp-col-12">

                            <div class="rp-headline-wrapper">
                                <h2>Persönliche Angaben</h2>
                            </div>

                            <form autocomplete="off" class="rp-form">
                                <div class="rp-row">
                                    <div class="rp-col-6 rp-col-sm-12">
                                        <div class="rp-form__group">
                                            <label id="pl_lbl_ptitle" class="rp-form__label">Titel</label>
                                            <input id="pl_ptitle" type="text" class="rp-form__data" />
                                        </div>
                                        <div class="rp-form__group">
                                            <label id="pl_lbl_pname" class="rp-form__label">Nachname</label>
                                            <input id="pl_pname" type="text" class="rp-form__data" />
                                        </div>
                                        <div class="rp-form__group">
                                            <label id="pl_lbl_pfname" class="rp-form__label">Vorname</label>
                                            <input id="pl_pfname" type="text" class="rp-form__data" />
                                        </div>
                                        <div class="rp-form__group">
                                            <label id="pl_lbl_pgender" class="rp-form__label">Geschlecht</label>
                                            <div class="rp-form__data-wrapper">
                                                <select id="pl_pgender" class="rp-form__data">
                                                    <option value=""></option>
                                                    <option value="M">M: männlich</option>
                                                    <option value="W">W: weiblich</option>
                                                    <option value="U">U: unbekannt</option>
                                                    <option value="X">X: unbestimmt</option>
                                                    <option value="D">D: divers</option>                                
                                                </select>
                                            </div>    
                                        </div>
                                    </div>
                                    <div class="rp-col-6 rp-col-sm-12">
                                        <div class="rp-form__group">
                                            <label id="pl_lbl_pbdate" class="rp-form__label">Geburtsdatum</label>
                                            <input id="pl_pbdate" type="text" class="rp-form__data" placeholder="TT.MM.JJJJ" />
                                        </div>
                                        <div class="rp-form__group">
                                            <label id="pl_lbl_ptel" class="rp-form__label">Telefon</label>
                                            <input id="pl_ptel" type="tel" class="rp-form__data" />
                                        </div>
                                        <div class="rp-form__group">
                                            <label id="pl_lbl_pemail" class="rp-form__label">E-Mail</label>
                                            <input id="pl_pemail" type="email" class="rp-form__data" />
                                        </div>
                                        <!--
                                        <div class="rp-form__group">
                                            <label id="pl_lbl_pemailConf" class="rp-form__label">E-Mail bestätigen</label>
                                            <input id="pl_pemailConf" type="email" class="rp-form__data" />
                                        </div>
                                        -->
                                        
                                        
                                    </div>
                                </div>
                            </form>

                        </div>

                    </div>
                </div>
            </section>
            
            
                        
            
            
            
            
            
            <!-- STEP 3: Fragen und Hinweise -->
            <section class="rp-wizard-content" id="step-3">
                <div class="rp-content-wrapper">

                    <div class="rp-row">

                        <div class="rp-col-12">

                            <div class="rp-headline-wrapper">
                                <h2>Hinweise</h2>
                            </div>
                            <div class="rp-row rp-mb-30">
                                <div class="rp-col-12">
                                    <ul id="pl_hints"></ul>
                                </div>
                            </div>                            
                            
                            <div id="pl_questCont">
                            
                                <div class="rp-headline-wrapper">
                                    <h2>Fragen</h2>
                                </div>

                                <p class="rp-mb-20">Bitte beantworten Sie, falls möglich, die nachfolgenden Fragen:</p>

                                <div class="rp-row">
                                    <div class="rp-col-12" id="pl_quest">

                                    </div>
                                </div>
                            
                            </div>
                            
                            
                            
                            
                        </div>

                    </div>
                </div>
                
            </section>

            
            
            
            
            
            
            
            
            
            
            
            
            
            
            <!-- STEP 4: Terminvorschläge -->
            <section class="rp-wizard-content" id="step-4">
                <div class="rp-content-wrapper">

                    <div class="rp-row">

                        <div class="rp-col-12">

                            <div class="rp-headline-wrapper">
                                <h2>Terminvorschläge</h2>
                            </div>

                        </div>

                    </div>

                    <div class="rp-row rp-mb-20 rp-form rp-form--vertical">

                        <div class="rp-col-6 rp-col-sm-12">
                            <div class="rp-form__group">
                                <label class="rp-form__label">Terminsuche ab</label>
                                <input type="text" class="rp-form__data " id="pl_searchStart" value="" onchange="pl_searchDateChanged( this );"/>     
                            </div>
                        </div>

                        <div class="rp-col-6 rp-col-sm-12">
                             <!-- Vorschlagskalender Filter  -->
                            <div class="rp-form__group">
                                <label class="rp-form__label">Standort</label>
                                <div class="rp-form__data-wrapper" id="pl_calFilter"></div> 
                            </div>
                        </div>

                    </div>

                    <div class="rp-row">

                        <div class="rp-col-12">

                            <p class="rp-mb-20">Wählen Sie einen Terminvorschlag aus:</p>
                            <p id="pl_beforeMinInfo" class="rp-mb-20 rp-bold" style="display:none;"></p>

                            <!-- Vorschlagskalender  -->
                            <div id="pl_cal">   
                            </div>

                            <!--
                            <div class="rp-mb-30" id="pl_curAppInfo" style="display:none;">
                                <div class="rp-d-flex">
                                    <h3 class="rp-label">Ausgewählter Termin</h3>
                                </div>
                                <h2 class="rp-mb-5" id="pl_selDate"></h2>
                                <p>Standort: <b id="pl_selLocation"></b></p>
                            </div>                    
                            -->
                            <div class="rp-row" id="pl_appSuggs">
                                
                               
                                
                            </div>

                        </div>

                    </div>
                </div>

            </section>

            

            
            

            <!-- STEP 5: Zusammenfassung -->
            <section class="rp-wizard-content" id="step-5">
                <div class="rp-content-wrapper">

                    <div class="rp-row">

                        <div class="rp-col-12">

                            <div class="rp-headline-wrapper">
                                <h2>Zusammenfassung</h2>
                            </div>

                            <div class="rp-row">
                                <div class="rp-col-6 rp-col-sm-12">
                                    <p class="rp-mb-20">Bitte kontrollieren Sie Ihre Angaben:</p>

                                    <div class="rp-mb-30">
                                        <div class="rp-d-flex">
                                            <h3 class="rp-label">Ausgewählter Termin</h3>
                                            <a href="#" onclick="pl_jumpToStep(4);" class="rp-icon rp-icon--sm rp-ml-10 rp-mt-n5"><i class="icon-edit"></i></a>
                                        </div>
                                        <h2 class="rp-mb-5" id="pl_sumDate"></h2>
                                        <p>Standort: <b id="pl_sumLocation"></b></p>
                                        
                                        <p id="pl_sumBeforeMinInfo" class="rp-mb-20 rp-bold" style="display:none;"></p>
                                        
                                        
                                    </div>
                                    <div class="rp-mb-30">
                                        <div class="rp-d-flex">
                                            <h3 class="rp-label">Untersuchungsdaten</h3>
                                            <a href="#" onclick="pl_jumpToStep(1);" class="rp-icon rp-icon--sm rp-ml-10 rp-mt-n5"><i class="icon-edit"></i></a>
                                        </div>
                                        <p id="pl_sumContRef">Zuweiser: <b id="pl_sumRef"></b></p>
                                        <p>Vertragsart: <b id="pl_sumVertragsart"></b></p>
                                        <p>Untersuchung: <b id="pl_sumExaName"></b></p>
                                    </div>
                                    <div class="rp-mb-30" id="pl_sumContPat">
                                        <div class="rp-d-flex">
                                            <h3 class="rp-label">Persönliche Angaben</h3>
                                            <a href="#" onclick="pl_jumpToStep(2);" class="rp-icon rp-icon--sm rp-ml-10 rp-mt-n5"><i class="icon-edit"></i></a>
                                        </div>
                                        <p>Name: <b id="pl_sumPatName"></b></p>
                                        <p>Geburtsdatum: <b id="pl_sumPatBDate"></b></p>
                                        <p>Geschlecht: <b id="pl_sumPatGender"></b></p>
                                        <p>Telefon: <b id="pl_sumPatTel"></b></p>
                                        <p>E-Mail: <b  id="pl_sumPatMail"></b></p>
                                    </div>
                                </div>

                                <div class="rp-col-6 rp-col-sm-12">
                                    
                                    <p class="rp-mb-20">Bitte tragen Sie die Daten Ihrer Überweisung hier ein:</p>

                                    <div class="rp-form rp-form--vertical rp-mb-30">                                    
                                        <div class="rp-form__group">
                                            <label  id="pl_sumDiagnoseLbl"  class="rp-form__label">Diagnose/Verdachtsdiagnose</label>
                                            <input id="pl_sumDiagnose" type="text" class="rp-form__data" />
                                        </div>      

                                        <div class="rp-form__group">
                                            <label  class="rp-form__label">Befund/Medikation</label>
                                            <input id="pl_sumBefund" type="text" class="rp-form__data" />
                                        </div>      

                                        <div class="rp-form__group">
                                            <label  id="pl_sumAuftragLbl" class="rp-form__label">Auftrag</label>
                                            <input id="pl_sumAuftrag" type="text" class="rp-form__data" />
                                        </div>    
                                    </div>  
                                    
                                    <div class="rp-mb-30" id="pl_sumHQ">
                                        <div class="rp-d-flex rp-mb-10">
                                            <h3 class="rp-label">Fragen</h3>
                                            <a href="#" onclick="pl_jumpToStep(3);" class="rp-icon rp-icon--sm rp-ml-10 rp-mt-n5"><i class="icon-edit"></i></a>
                                        </div>
                                        <div class="rp-mb-30" id="pl_sumContHQ">
                                            <ul id="pl_sumQuestions"></ul>
                                            <!--<ul id="pl_sumHints"></ul>-->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                
            </section>

        </div>
    </div>

    <!-- Footer -->
    <div id="footer" class="rp-buttonbar rp-buttonbar--page">
        <div class="rp-row">
            <div class="rp-col-12">
                <div class="rp-buttonbar__a-left">
                    <!-- TO DO DAVID: Zurück Btn soll immer zu vorigem Step linken  index.html -->
                    <a href="#" id="pl_but_prev" style="display:none;" onclick="pl_prevStep()" class="rp-link rp-link--back">Zurück</a>
                </div> 

                <div class="rp-buttonbar__a-right">

                    <!-- Ausgew. Vorschlag oben -->    
                    <div id="pl_curAppInfo" class="rp-selected-app" style="display:none;">
                        <h3 class="rp-label rp-mb-0">Ausgewählter Termin</h3>
                        <p class="rp-bold" id="pl_selDate"></p>
                        <!--<p class="rp-bold" id="pl_sumLocation"></p>-->
                    </div>   

                    <!-- TO DO DAVID: Weiter Btn soll immer auf nächsten Step linken thankyou.html -->
                    <a href="#" id="pl_but_next" class="rp-btn" onclick="pl_nextStep()">Weiter</a>
                    
                    <!-- TO DO DAVID: bei Step 5 Weiter Btn ausblenden und Termin buchen Btn einblenden -->
                    <a href="#" class="rp-btn" id="pl_but_book" onclick="pl_bookApp()" style="display: none;">Termin buchen</a>
                </div>
            </div>
        </div>
    </div>
    
    
    <!-- Validier Hinweis -->    
    <div id="dialog_vali" class="rp-overlay rp-overlay--layer-2" style="display:none;">
        <div class="rp-dialog rp-dialog--sm">
            <div class="rp-dialog__header">
                <i class="rp-dialog__img rp-icon icon-warning"></i>
                <h2 id="dialog_vali_header"></h2>
            </div>
            <div class="rp-dialog__content" id="dialog_vali_msg">
            </div>
            <div class="rp-buttonbar rp-buttonbar__a-right">
                <a href="#" class="rp-btn" id="" onClick="$('#dialog_vali').hide();">OK</a>
            </div>
        </div>
    </div>    
    
    

<script>

    $(document).ready(function() {
        
        var navListItems = $('ul.rp-wizard li a'),
            allWells = $('.rp-wizard-content');

        allWells.hide();


        /* datepicker init mit heute als Datum  und KEIN Daten in Vergangenheit anbieten */
        
        $("#pl_searchStart").datepicker({ dateFormat: "dd.mm.yy", minDate : 0, date: new Date() });
        /* Aktuelles datum in Suche ab Feld */
        $("#pl_searchStart").datepicker("setDate", new Date() );
        
        
        /*
        navListItems.click(function(e)
        {
            e.preventDefault();
            var $target = $($(this).attr('href')),
                $item = $(this).closest('li');
            
            if (!$item.hasClass('rp-disabled')) {
                navListItems.closest('li').removeClass('rp-active');
                $item.addClass('rp-active');
                allWells.hide();
                $target.show();
            }
        });
         $('ul.rp-wizard li.rp-active a').trigger('click');
        */
       
       
        /* vali err weg bei change */
        $("#pl_vertragsart").on("change", function(event) { 
             removeErrorClasses( ["pl_vertragsart","pl_vertragsartLbl" ]);
        } );        
        
       
       
        
        pl_jumpToStep( "1" );        
        
        initOpenCore();
        
        initBase( true );
        
 

        

          
    });

    


/*
<a id="pl_stepBut_4" data-step="4" onclick="showStep(this);" href="#step-4">4</a>
*/
    var HIDE_OTHER_DAYS = true;

    var pl_curStep = -1;
    var pl_selectedSugg = undefined;
    var pl_curHQ = undefined;
    var pl_curFA = undefined;
    var pl_curFAKey = "";
    var pl_curStartDate = "";
    var pl_curPatData;
    var pl_curGData;
    var pl_useCalendar = "weekView";
    
    
    function reinitState(){
        try{
           
            pl_curStep = -1;
            pl_selectedSugg = undefined;
            pl_curHQ = undefined;
            pl_curFA = undefined;
            pl_curFAKey = "";
            pl_curStartDate = "";
            pl_curGData = undefined;
            pl_useCalendar = "weekView";            
            
            
        }
        catch(err){
            
            
        }
        
    }
    
    
    
    var TESTMODE = false;
    if( TESTMODE){alert("TEST MODE ACTIVE!")};
    
    function pl_insertTestData(){
        try{
            /* Test Pat Daten rein */
            
            
            $("#pl_ptitle").val("Dr.");
            $("#pl_pname").val("Test");
            $("#pl_pfname").val("Adalber");
            $("#pl_pgender").val("M");
            $("#pl_pbdate").val("01.01.1980");
            $("#pl_pemail").val("test@retura.de");
            /*$("#pl_pemailConf").val("test@retura.de");            */
            
            
            
            
        }
        catch( err ){
            
            
        }
        
    }
    
    

    function pl_prevStep(){
        
        var pstep = pl_curStep - 1;
        
        if( pstep < 1 ){
            pstep = 1;
        }
        
        pl_jumpToStep( pstep );
        
    }

    function pl_nextStep(){
        
        var pstep = pl_curStep + 1;
        
        if( pstep > 5 ){
            pstep = 5;
        }
        
        pl_jumpToStep( pstep );
        
    }



    function pl_showStep( ele ){
        var step = $(ele).attr("data-step");
        
        /* alert("pl_showStep: " + step ); */
        pl_jumpToStep( step );
        
    }


    function pl_jumpToStep( pnum ){
        
        try{
            
            /* zu verlassene Seite Validieren */
            if( ! pl_validateStep( pl_curStep, pnum ) ){
                return;
            }
        
            
            /* Bei Schritt 5 Zusammenfassung den Buchen button anziegen und "weiter" verstecken */
            if( 1 == pnum ){
               $("#pl_but_prev").hide(); 
            }
            else{
                $("#pl_but_prev").show(); 
            }
            
            
            if( 1 == pnum ){
                $("#pl_but_next").show();
                $("#pl_but_book").hide();
            }
            if( 5 == pnum ){
                $("#pl_but_next").hide();
                $("#pl_but_book").show();
            }
            else{
                $("#pl_but_next").show();
                $("#pl_but_book").hide();
            }
            
        
        
        
        
            /* #step-1 */
            var view = $( "#step-" + pnum );
            var li = $( "#pl_stepBut_" + pnum );
            
            
            allWells = $('.rp-wizard-content');
            allWells.hide();
            
            view.show();
            
            $("#pl_stepButCont li").removeClass("rp-active");
            li.addClass( "rp-active" );
         
            pl_curStep = parseInt(pnum);
            
            pl_stepViewShowed( pnum );
            
        }
        catch( err ){
            console.log("pl_jumpToPage err: " + err );
            console.log( err.stack );
        }
        
    }

    function pl_stepViewShowed( pnum ){
        
        /* alert("pl_stepViewShowed: " + pnum ); */
        switch( pnum ){
            /* Terminvorschläge view geöffnet */
            case 4:
                pl_findAppointments();
                break;
            
            /* Fragen und Hinweise */
            case 3:
                /* pl_showHintsQuestionsForSugg( pl_selectedSugg, pl_curPatData ); */
                pl_showHintsQuestionsForEtn( getSelectedEtnDuuid(""), pl_curPatData ); 
                
                break;
            
            
            /* Zusammenfassung */
            case 5:
                pl_renderSummary();
            
            
            
        }
        
        
    }





    function pl_validateStep( pnum, toStep ){
        if( pnum < 0 ){ return true; }
        
        
        
        switch( pnum ){
            
            /* Untersuchungsdaten */
            case 1:
                /* Vertragsart muss gewählt sein */
                if( ! validateSelBoxFilled( "pl_vertragsart", "Bitte wählen Sie eine Vertragsart aus.", "pl_vertragsartLbl" ) ){
                    return false;
                }
                
                
                var selEtnDuuid = getSelectedEtnDuuid( "" );
                if( "" == selEtnDuuid ){
                    
                    addErrorClass("pl_chooseExaLbl");
                    
                    showValiMsg( "Bitte wählen Sie eine Untersuchung aus. Sie können Untersuchungen entweder über die Auswahlfelder 'Modalität' und 'Körperregion' suchen oder direkt über das Suchfeld." );                    
                    return false;
                }
                
                
                break;
            

            
            /* Patienten Daten Vlai, nur wenn step vor */
            case 2: 
                if( toStep > pnum ){
                    return pl_patDataValid();
                }
                break;

            
            /* Terminvorschläge */
            case 4:
                /* Ein Vorschlag muss gewählt sein wenn auf Weiter */
                if( 5 == toStep && pl_selectedSugg == undefined ){
                    showValiMsg( "Bitte wählen Sie einen Terminvorschlag aus." );                    
                    return false;
                }
                
                
                
                break;
            
            
            
            /* Fragen und Hinweise */
            case 3:
                if( toStep > pnum ){
                    return pl_validateHintsAnswers();
                }
                break;

            
            
            
            
            //pl_selectedSugg = sugg;
            
            
        }
        
        
        /*
        <select id="pl_vertragsart" class="rp-form__data" required>
        */
        
        
        
        
        /*alert("validate: " + pnum ); */
        
        return true;
        
        
        
        
        /* alles ok, page darf verlassen werden */
        return true;
        
    }

    function validateSelBoxFilled( eleId, vmsg, lblEleId ){
        
        try{
            
            var vele = $( "#" + eleId );
            
            if( vele.val() == undefined || vele.val().length == 0 ){
                
                /* rot markieren */
                vele.addClass( "rp-val-error" );
                
                /* lbl dabei? Auch rot! */
                if( lblEleId != undefined ){
                    $("#"+lblEleId).addClass( "rp-val-error" );
                }
                
                showValiMsg( vmsg );
                return false;

            }
            else{
                vele.removeClass( "rp-val-error" );
                
                /* lbl dabei? Auch  */
                if( lblEleId != undefined ){
                    $("#"+lblEleId).removeClass( "rp-val-error" );
                }
                
                return true;
            }
        }
        catch( err ){
            console.log( err );
        }
    }


    function removeErrorClasses( eleIdA ){
        for( var ex in eleIdA ){
            $( "#" + eleIdA[ex] ).removeClass( "rp-val-error" );
        }
    }

    
    
    


    function validateInputFilled( eleId, vmsg ){
        
        try{
            
            var vele = $( "#" + eleId );
            
            if( vele.val() == undefined || vele.val().length == 0 ){
                
                /* rot markieren */
                vele.addClass( "rp-val-error" );
                showValiMsg( vmsg );
                return false;

            }
            else{
                vele.removeClass( "rp-val-error" );
                return true;
            }
            
        }
        catch( err ){
            console.log( err );
            
        }
        
    }
    
    function addErrorClass( eleId ){
        var vele = $( "#" + eleId );
        vele.addClass( "rp-val-error" );
    }
    
    function removeErrorClass( eleId ){
        var vele = $( "#" + eleId );
        vele.removeClass( "rp-val-error" );
    }
    
    function showValiMsg( vmsg ){
        
    
        
        /* Header setzen */
        $("#dialog_vali_header").html( "Hinweis" );

        /* Text in Fehlerdiv setzen */
        $("#dialog_vali_msg").html( vmsg );

        /* alert("show vali msg!"); */

        /* DIV einblenden */
        $("#dialog_vali").show();
        /* alert( vmsg ); */
        
    }
    
    
    
    
    function showValiMsgA( vmsgA ){
        
    
        
        /* Header setzen */
        $("#dialog_vali_header").html( "Hinweis" );

        /* Text in Fehlerdiv setzen */
        $("#dialog_vali_msg").html( vmsgA.join("<br/>") );

        /* alert("show vali msg!"); */

        /* DIV einblenden */
        $("#dialog_vali").show();
        /* alert( vmsg ); */
        
    }
    
    
    
    
    
    
    function showInfoMsg( vmsg ){
        alert( vmsg );
        
    }
    

    /*
     * TERMINSUCHE
     */

    function pl_searchDateChanged( ele ){
         pl_findAppointments( );
    }


    function pl_insertBeforeMinInfo( eleId, short ){
        
        
        /* <p id="pl_sumBeforeMinInfo" class="rp-mb-20" style="font-weight: bold;display:none;"></p> */
        
        /* Minuten vorher erscheinen Hinweis */
        var beforeMin = 0;
        try{
            var etn = getSelectedEtn( "" );
            if( etn != undefined ) {beforeMin = etn.beforeMin;}

            if( beforeMin > 0 ){
                if( true == short){ 
                    $("#" + eleId ).html( "<font class='rp-highlight'>Bitte erscheinen Sie " + beforeMin.toString() + " Minuten vorher.</font>" );
                }
                else{
                    $("#" + eleId ).html( "Bitte erscheinen Sie für diese Untersuchung " + beforeMin.toString() + " Minuten vorher in der Praxis." );
                }
                $("#" + eleId ).show();
            }
            else{
                $("#" + eleId ).hide();
                
            }
        }
        catch( etnerr ){
            
        }
                
    }



    function pl_findAppointments(){
        
        var vart = $( "#pl_vertragsart" ).val();
        var etnDuuid = getSelectedEtnDuuid("");
        
        pl_insertBeforeMinInfo( "pl_beforeMinInfo", false );

        
        
        
        /* im cache? */
        var faKey = vart + etnDuuid;

        /* Startdatum */
        var startIso = undefined;
        try{
            
            
            
            
            startIso = reformatDate( $("#pl_searchStart").val(), "DD.MM.YYYY", "YYYY-MM-DD", "");

            /* kein Datum drin? Dann heute nehmen */
            if( startIso.length == 0 ){
                
                startIso = moment( new Date() ).format( "YYYY-MM-DD" );
                
                
            }


            /* Uhrzeit dran wenn Datum gesetzt */
            if( startIso.length > 0 ){
                startIso += "T00:00:00";
            }

            /* zu weit in Zukunft? */
            if( "2028" < startIso ){
                return;
            }
        }
        catch( derr ){}    

        /* alert("pl_findAppointments: startIso: " + startIso ); */


        
        if( faKey == pl_curFAKey && startIso == pl_curStartDate ){
            /* pl_renderAppSuggestions( resp );     */
            /* alert("cached fa!"); */
            return;
        }
        
        
        /* Ausgewählter Termin verstecken */
        $("#pl_curAppInfo").hide();
        
        
        pl_curFAKey = faKey;
        
        
        var paras = {
            "financial_class": vart,
            "etnDuuid": etnDuuid,
            "appId": "planer"
        };
        
        if( startIso != undefined ){
            paras.start = startIso;
            pl_curStartDate = startIso;
        }        
        
        
        /* paras.maxSuggestions = 200; */
        
        /*
        alert("pl_findAppointments: vart: " + vart + "  etnDuuid: " + etnDuuid + " paras:\n" + jstr( paras ) );
        */
        
        
        /* "globalQuestions" rein!  appData.globalQuestions = state.globalQuestions; */
        
        /*  examinationJO.containsKey( "questions" )  rein! */
        
        
        try{
            
            if( pl_curHQ.questions != undefined ){
                paras.questions =  pl_curHQ.questions;
            }
            
            paras.hintsAnswers = pl_getHintsAnswers();
            
        }
        catch( haErr ){}
        
        
        
        
        
        oc_callService( "findAppointments", paras,
            function( resp ){
                pl_curFA = resp;
                
                if( "monthView" == pl_useCalendar ){
                    pl_renderAppSuggestionsMonthView( resp );
                }
                else{
                    pl_renderAppSuggestionsWeekView( resp );
                    
                }
                
            }
            
        );
        
        
        
        
        
        
    }

    /* Vorschläge gruppieren */
    function pl_groupSuggs( suggA, groupBy ){
        
        var gData = {};
        
        gData.groupBy = groupBy;
        
        var groupsHM = {};
        
       
        
        for( var sx in suggA ){
            var sugg = suggA[ sx ];
            
            var calD = moment( sugg.start ).format("YYYY-MM-DD");
             

            
             var groupId = "all";
             switch( groupBy ){
                 case "loc":
                     groupId = sugg.location;
                     break;
             }
            
            
             var groupHM = groupsHM[ groupId ];
             if( groupHM == undefined ){
                 groupHM = {};
                 
                 groupHM.calStartDate = "9999";
                 groupHM.selectedDates = [];
                 groupHM.suggCount = 0;
                 groupHM.dates = {};
                 
                 groupsHM[ groupId ] = groupHM;
                 
             }

             /* Flag für Kalender setzen */
             if( !groupHM.selectedDates.includes( calD ) ){
                    groupHM.selectedDates.push( calD );
                    
                    if( groupHM.calStartDate > calD ){
                        groupHM.calStartDate = calD;
                    }                    
             }                         
             
             
             
             
             var gA;
             if( groupHM.dates[ calD ]!= undefined ){
                gA = groupHM.dates[ calD ];
             }
             else{
                gA = [];
                groupHM.dates[ calD ] = gA;
             }
             groupHM.suggCount++;
             gA.push( sugg );
             
        }
        
        
        gData.groupHM = groupsHM;
        
        //alert("gData:\n" + jstr(gData) );
        
        return gData;
        
    }




    /* Vorschläge rendern mit Wochenkalender */
    function pl_renderAppSuggestionsWeekView( resp ){
        /* alert("findAppointments RESP: " + jstr( resp ) );  */
        
        if( resp.findAppointmentsResp == undefined || resp.findAppointmentsResp.suggestions == undefined ){
            pl_renderNoSuggestionsInfo(  );
            return;
        }
        
        var suggA = resp.findAppointmentsResp.suggestions;
        
        /* Gruppierung nach Standort */
        var gData = pl_groupSuggs( suggA, "loc" );
        pl_curGData = gData;
        
        /* Gruppen Filter erzeugen */
        var gInfo = pl_renderAppSuggestionsCalendarFilter( gData )
        
        pl_selectCalendarFilter( gInfo );
       
        
    }
    
    /* Vorschläge rendern mit Wochenkalender */
    function pl_renderAppSuggestionsWeekViewCal( gInfo ){
        
        
       
        
        /* alert("findAppointments RESP: " + jstr( resp ) ); */
        pl_renderAppSuggestionsWeekCalendarView( gInfo );
        
    }    
    
    
    
    
    
    function pl_renderAppSuggestionsCalendarFilter( gData ){
    
        /* Gibt es überhaupt mehr als eine Gruppe? */
        var gInfo = {
            groupId: "",
            groupLbl: ""
        }
        
        
        if( Object.keys(gData.groupHM).length > 0 ){
            
            var hA = [];
            
            var groupBy = gData.groupBy;
            
            var firstDay = "9999";
            var firstDayGroupId = "";
            
            //alert("pl_renderAppSuggestionsCalendarFilter: groupBy: " + groupBy );
            /* groudType? */
            
            for( var groupId in gData.groupHM ){

                

                var groupLbl = "";
                
                switch( groupBy ){
                    
                    case "loc":
                        groupLbl = getLocationData( groupId ).city;
                        break;
                    
                    default:
                        hA.push(groupId);        
                }                
                
                var hourGInfo = {
                    groupId: groupId,
                    groupLbl: groupLbl
                    
                };
                
                
                
                if( groupId != undefined && groupId.length > 0 ){
                //var hourGInfo;
                    hA.push('<div class="rp-pill rp-mt-0 rp-mb-5" data-groupId="' + groupId + '" data-gInfo="' + jsonObjToB64(hourGInfo) + '" onclick="pl_selectCalendarFilter(b64ToJsonObj($(this).attr(\'data-gInfo\')));">');
                }
                
                
                
                if( gData.groupHM[groupId].calStartDate < firstDay ){
                    firstDay = gData.groupHM[groupId].calStartDate;
                    firstDayGroupId = groupId;
                    gInfo.groupId = groupId;
                    gInfo.groupLbl = groupLbl;
                }
                

                
                hA.push( groupLbl );
                
                /* Anzahl Vorschläge */
                //hA.push(' ');
                //hA.push( gData.groupHM[ groupId ].suggCount );
                //hA.push(' Termine ');
                
                /* frühestes Datum */
                //hA.push(' ab dem ');
                //hA.push( reformatDate( gData.groupHM[groupId].calStartDate, "YYYY-MM-DD", "ddd DD.MM.YYYY", gData.groupHM[groupId].calStartDate ) );
                
                
                
                hA.push('</div>');
                
                
                
                
            }
            
            
            $("#pl_calFilter").html( hA.join("") );
            
            //alert("firstDayGroupId: " + firstDayGroupId  + " firstDay: " + firstDay );
            
            return gInfo;
            
        }
        else{
            /* key von einzieger Gruppe zurück */
            
            gInfo.groupId = Object.keys(gData.groupHM)[0];
            
            return gInfo;
        }
        
   
    
    }
    
    
    function pl_selectCalendarFilter( gInfo ){
        
        //alert("pl_selectCalendarFilter: " + groupId );
        
        $("#pl_calFilter .rp-pill").removeClass("rp-active");
        $("#pl_calFilter .rp-pill[data-groupId=" + gInfo.groupId + "]").addClass("rp-active");
        
        pl_renderAppSuggestionsWeekViewCal( gInfo );
        
    }
    
    
    
   
    
    function pl_renderAppSuggestionsWeekCalendarView( gInfo ){
        
        /*
           var gInfo = {
            groupId: "",
            groupLbl: ""
        }
        */
        var groupHM = pl_curGData.groupHM[ gInfo.groupId ];
        
        
        var dayHM = pl_convertSuggsToDayHM( groupHM );
        
        
        //alert("pl_renderAppSuggestionsWeekCalendarView: dayHM:" + jstr(dayHM));
        
        // alert("pl_renderAppSuggestionsWeekCalendarView: dayHM size:" + Object.keys(dayHM).length );
        
        
        
        
        /* MUSS montags anfangen! */
        var prevMonD = moment( groupHM.calStartDate, "YYYY-MM-DD").startOf('isoWeek').toDate();
        
        
        /*Gruppen Label vor Monate schreiben */
        var monthA = ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];
        
        /* 2022-05-23: Umgestellt auf calLabel setting */
        /*
        for( var mx in monthA ){
            monthA[mx] = gInfo.groupLbl + " " + monthA[mx];
        }
        */
        
        
        
        
        $('#pl_cal').markyourcalendar({
            availability: [], 
            
            
            "dayHM": dayHM,
            "calLabel": gInfo.groupLbl + " ",
            
            //isMultiple: true
            startDate: prevMonD,
            //startDate: moment( "2021-06-01", "YYYY-MM-DD").startOf('isoWeek').toDate(),
            months: monthA,
            weekdays: ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'],
            
            onClick: function(ev, data, selectedUids) {
                
              // data is a list of datetimes
              // alert(jstr(data) + "\nselUids:\n" + jstr( selectedUids ) );
              
              if( selectedUids != null && selectedUids.length > 0 ){
                  pl_selectSuggById( selectedUids[0] );
              }
              else{
                  /* deselect! */
                  pl_deSelectSugg();
                  
              }  
              
/*              
              
[
  "2021-06-02 12:15:00"
]
selUids:
[
  "db4a7551-f178-4b04-aa73-7af7f9b72440"
]              
*/              
              
              
              
            },
            onClickNavigator: function(ev, instance) {
              //alert("onClickNavigator:" + instance.getSettings().startDate );  
                
            }
            
            
            
        });        
        
        
        
        
    }
    
    function pl_convertSuggsToDayHM( groupHM ){
        
        var dayHM = {};
        
        //alert("pl_convertSuggsToDayHM groupHM:\n" + jstr( groupHM ));
        
        dateHM = groupHM.dates;
        
        
        /*console.log("pl_convertSuggsToDayHM groupHM:\n" + jstr( groupHM ));*/
        
        
        
        for( var isoDate in dateHM ){
            var suggA = dateHM[ isoDate ];
            var timeA = [];
            
            
            
            for( var s in suggA ){
                
                //alert("suggA:\n" + jstr( suggA ) );
                
                var tpos = suggA[s].start.indexOf("T");
                var tpos2 = suggA[s].start.lastIndexOf(":");
                
                
                
                
                if( tpos != -1 ){
                    var time = suggA[s].start.substring( tpos + 1, tpos2 );
                    
                    /* Test */
                    // time += " " + suggA[s].id;

                    timeA.push(
                            {
                                "uid": suggA[s].id,
                                "time": time
                            }
                    );
                
                }
            }
            dayHM[ isoDate ] = timeA;
        }
        return dayHM;
        
    }

/*
      "2021-06-01": [
        {
          "start": "2021-06-01T13:30:00",
          "end": "2021-06-01T13:50:00",
          "location": "PAF",
          "durationMin": 20,
          "id": "d0d46059-3e8d-4cb8-9b25-e766296bb571",
          "score": 0,
          "orderModMixed": false,
          "exaList": [
            {
*/






    /* Vorschläge rendern mit Monatskalender */
    function pl_renderAppSuggestionsMonthView( resp ){
        /* alert("findAppointments RESP: " + jstr( resp ) ); */
        
        if( resp.findAppointmentsResp == undefined || resp.findAppointmentsResp.suggestions == undefined ){
            pl_renderNoSuggestionsInfo(  );
            return;
        }
        
        var suggA = resp.findAppointmentsResp.suggestions;
        
        /* Tage für Kalender */
        var selectedDates = [];
        
        /* frühester Tag im Cal */
        var calStartDate = "9999";        
        
        var datesHM = {}
        
        /* Verschläge in Tage und Standorte Gruppieren */
        for( var sx in suggA ){
            var sugg = suggA[ sx ];
            
             var calD = moment( sugg.start ).format("YYYY-MM-DD");
            
             /* Flag für Kalender setzen */
             if( !selectedDates.includes( calD ) ){
                    selectedDates.push( calD );
                    
                    if( calStartDate > calD ){
                        calStartDate = calD;
                    }                    
             }             
             
             var locHM;
             if( datesHM[ calD ]!= undefined ){
                locHM = datesHM[ calD ];
             }
             else{
                locHM = {};
                datesHM[ calD ] = locHM;
             }
             
             
            if( locHM[sugg.location] != undefined ){
                locHM[sugg.location].push( sugg );
            }
            else{
                locHM[sugg.location] = [];
                locHM[sugg.location].push( sugg );
            }
        }
                
        //alert("datesHM:\n" + jstr( datesHM ) );        
        
        var hA = [];
        
        
        /*  sort */
        var sortA = getSortedKeysByStringComp( datesHM );
        
        //alert("sortA\n" + jstr( sortA ) );        
        var isFirstDay = true;
        
        for( var sx in sortA ){
            var dayLocHM = datesHM[ sortA[sx].key ];
            
            /* EinzelenTag rendern ganze Breite  */
            hA.push( '<div data-date="' + sortA[sx].key + '" class="daycont rp-col-12 rp-col-sm-12"' );
            
            /* Soll nur ein Tag jeweils Details zeigen? */
            if( true == HIDE_OTHER_DAYS && !isFirstDay ){
                hA.push( ' style="display:none;"' );
            }
            hA.push( '>' );
            
            
            
            /* Tagesdatum formatieren */
            var fd = moment( sortA[sx].key, "YYYY-MM-DD" ).format( "ddd, DD.MM.YYYY");
                
            
            var locCount = Object.keys( dayLocHM ).length;
            
            
            /* als table rendern (erstmal) */
            hA.push( '<table id="pl_sugCal" class="rp-table rp-list rp-list--clickable">' );
           
            
            
            /* Standorte sortieren */
            lsortA = getSortedKeysByStringComp( dayLocHM );
            
            var showDate = true;
            
            for( var lx in lsortA ){
                
                hA.push( '<tr class="" data-date="' + sortA[sx].key + '"' );
             
                /* Soll nur ein Tag jeweils Details zeigen? */
                /*
                if( true == HIDE_OTHER_DAYS && !isFirstDay ){
                    hA.push( ' style="display:none;"' );
                }
                */
                hA.push( '>' );
             
                /* Datum nur in erster row  */ 
                if( showDate ){
                    hA.push( '<td width="10%">' + fd + '</td>' );                
                    showDate = false;
                }
                else{
                    hA.push( '<td width="10%">&#160;</td>' );                
                    
                }
                
                
                var locSuggA = dayLocHM[ lsortA[ lx ].key ];
                
                hA.push( '<td width="70%" style="flex-wrap: wrap;">' );
                for( var tx in locSuggA ){
                    var sugg = locSuggA[ tx ];
                    
                    var sdate =  moment( sugg.start ).format( "HH:mm") + " Uhr";
                    
                    
                    /* Uhrzeiten als div */
                    hA.push( '<div onclick="pl_selectSugg(this)" class="hour" ' );

                    hA.push( 'data-sugg="' );
                    hA.push( jsonObjToB64( sugg ) );
                    hA.push( '">' + sdate + '</div>' );                    
                }
                hA.push( '</td>' );
                
                /* StandortName */
                var locData = getLocationData( lsortA[ lx ].key );
                hA.push( '<td width="20%">' + locData.zip +' ' + locData.city + '</td>' );
                
                hA.push( '</tr>'  );
            }
            
           
           
            
            
            
            hA.push( '</table>' );
            
            
            hA.push( '</div>' );
            
            isFirstDay = false;
        }
        
        
       
        
        
        $("#pl_appSuggs").html( hA.join("") );
        
        
        /* Kalender */
        
        var nowD = new Date();
        
        
        /* calendar view */
        $("#pl_cal").calendar({
            date: calStartDate,
            weekDayLength: 2,
            startOnMonday: true,
            todayButtonContent: "Heute",
            enableYearView: false,
            showTodayButton: false,
            prevButton: "<<",
            nextButton: ">>",
            onClickDate: function( date, srcEle ){
                
                 
                
                /* alert("onClickDate:" + date + " srcEle: " +  srcEle );  */
                try{
                    
                    /* kann nur gemacht werden, wenn Tag auch Termine hat +class selected */
                    if( !$(srcEle).hasClass("selected") ){
                        return;
                    }
                    
            
                    pl_kalHighlightDay( "pl_cal", date );
                    /*
                    $("#pl_cal span.kalDayHighlight").removeClass( "kalDayHighlight" );
                    $(srcEle).find("span").addClass( "kalDayHighlight" );
                    */
                }
                catch(err){}
                
                pl_selectSugDate( date );
            },
            "selectedDates": selectedDates
            
        });        
        
         pl_kalHighlightDay( "pl_cal", calStartDate );
        
        
    }
    
    
    
    
    
    
    
    
    
    
    
    
 
    
    
    
    
    /* Bestimmten Tag in Tagesliste highlighten */
    function pl_selectSugDate( date ){
        
        try{
            
            $("#pl_sugCal tr").removeClass( "rp-active" );
            
            /* alle anderen Datumasngaben ausblenden */
            if( true == HIDE_OTHER_DAYS ){
                $("#pl_appSuggs div.daycont").hide();
            }
                        
            var calD = moment( date ).format("YYYY-MM-DD");
       
            /* alert("pl_selectSugDate: " + calD ); */
            var ele = $("#pl_sugCal tr[data-date='" + calD + "']");
            //ele.addClass( "rp-active" );
            
            if( true == HIDE_OTHER_DAYS ){
                /* ele.show(); */
                
                $("#pl_appSuggs div[data-date='" + calD + "']").show();
                
                
            }            
            
            /* ele.get(0).scrollIntoView( true ); */
            if( true != HIDE_OTHER_DAYS ){
                $('html,body').animate({scrollTop: ele.offset().top - 60 },'slow');
            }
            
        }
        catch( err ){
            console.log( "pl_selectSugDate ERROR: " + err );
            
        }
    }
    
    



    /* Vorschläge rendern nach Stadnorten getrennt */
    function pl_renderAppSuggestionsLocSplit( resp ){
        /* alert("findAppointments RESP: " + jstr( resp ) ); */
        
        if( resp.findAppointmentsResp == undefined || resp.findAppointmentsResp.suggestions == undefined ){
            pl_renderNoSuggestionsInfo(  );
            return;
        }
        
        var suggA = resp.findAppointmentsResp.suggestions;
        
        /* Tage für Kalender */
        var selectedDates = [];
        
        
        /* Split auf location "location": "PAF", */
        var locHM = {};
        
        
        for( var sx in suggA ){
            var sugg = suggA[ sx ];
            
            if( locHM[sugg.location] != undefined ){
                locHM[sugg.location].push( sugg );
            }
            else{
                locHM[sugg.location] = [];
                locHM[sugg.location].push( sugg );
                
                /* alert("location: " + sugg.location ); */
            }
            
            
        }
        
        var hA = [];
        
        /* Standorte rendern */
        
        for( loc in locHM ){
            var locData = getLocationData( loc );
            
            hA.push( '<div class="rp-col-4 rp-col-md-6 rp-col-sm-12">' );
            
            /* Standort Infos */
            hA.push( '<h3>Standort: '+ locData.zip +' ' + locData.city + '</h3>' );
            
            hA.push( '<ul class="rp-list rp-list--clickable rp-mb-30">' );
            
            for( var sx in locHM[ loc ] ){
                var sugg = locHM[ loc ][ sx ];
                
                /* Datum formatieren */
                var fd = moment( sugg.start ).format( "ddd, DD.MM.YYYY HH:mm") + " Uhr";
                
                /* Tag für Kalender */
                var calD = moment( sugg.start ).format("YYYY-MM-DD");
                
                if( !selectedDates.includes( calD ) ){
                    selectedDates.push( calD );
                }
                
                
                /* Mo, 10.03.2021 - 09:30 Uhr */
                
                /* json mit rein */
                hA.push( '<li onclick="pl_selectSugg(this)" class="rp-list__item" ' );
                
                hA.push( 'data-sugg="' );
                hA.push( jsonObjToB64( sugg ) );
                
                
                
                hA.push( '">' + fd + '</li>' );
                
            }
            
            
            
            hA.push( '</ul>' );
            
            
            hA.push( '</div>' );
            
        }
        
        
        
        $("#pl_appSuggs").html( hA.join("") );
        
        
        /* Kalender */
        
        var nowD = new Date();
        
        
        /* calendar test */
        $("#pl_cal").calendar({
            date: nowD,
            weekDayLength: 2,
            startOnMonday: true,
            todayButtonContent: "Heute",
            enableYearView: false,
            showTodayButton: false,
            prevButton: "<<",
            nextButton: ">>",
            onClickDate: function( date ){
                alert("onClickDate:" + date );
                
            },
            "selectedDates": selectedDates
            
        });        
        
        
        
        
    }
    
    
    
    
    function pl_selectSuggById( suggId ){
        //alert("pl_selectSuggById: " + suggId );
        //alert("pl_selectSuggById: pl_curFA: " + jstr(pl_curFA) );
        
        var sugg = pl_findSuggById( suggId );
        
        if( sugg != undefined ){
            
            oc_callService( "reserveAppointment", {"suggestion": sugg }, 
                function( resp ){
                    /* alert("reserveAppointment resp:\n" + jstr( resp ) ); */
                    
                    if( true == resp.success ){
                        pl_selectedSugg = sugg;
                        pl_showSelectedAppInfos( pl_selectedSugg );
                    }
                    else{
                        /* Terminslot konnte nicht mehr reserviert werden*/
                        showInfoMsg("Dieser Terminblock steht leider nicht mehr zur Verfügung.")
                    }    
                    
                }
            );            
        }
    }
    
    
    function pl_deSelectSugg(  ){
        
        if( pl_selectedSugg != undefined ){
            
            
            oc_callService( "cleanReservation", {}, 
                function( resp ){
                    pl_showSelectedAppInfos( undefined );        
                    
                    //alert("cleanReservation resp:\n" + jstr( resp ) );
                }
            );                        
            
            
            
            
            
        }
        
        
        //alert("pl_selectSuggById: " + suggId );
        //alert("pl_selectSuggById: pl_curFA: " + jstr(pl_curFA) );
        /*
        var sugg = pl_findSuggById( suggId );
        
        if( sugg != undefined ){
            
            oc_callService( "cleanReservation", {"suggestion": sugg }, 
                function( resp ){
                    
                    if( true == resp.success ){
                        pl_selectedSugg = sugg;
                        pl_showSelectedAppInfos( pl_selectedSugg );
                    }
                    else{
                        showInfoMsg("Dieser Terminblock steht leider nicht mehr zur Verfügung.")
                    }    
                    
                }
            );            
        }
        */
    }




    function pl_findSuggById( suggId ){
         try{
            if( pl_curFA != undefined ){
                var suggA = pl_curFA.findAppointmentsResp.suggestions;

                for( var sx in suggA ){
                    if( suggId == suggA[sx].id ){
                        return suggA[sx];
                    }
                }
            }

        }
        catch(err){
            console.log("pl_selectSuggById: " + err );
            
        }       
        
    }
        
    
    
    function pl_selectSugg( ele ){
        
        try{
            $("#pl_appSuggs div").removeClass( "rp-active" );
            
            ele = $( ele );
            var sugg = b64ToJsonObj( ele.attr( "data-sugg" ) );

            /* alert("pl_selectSugg:\n" + jstr( sugg ) ); */

            /* Tagecontainer auch highlighten falls noch nicht geschehen */
            
            var ptr = ele.closest("tr");
            
            if( !ptr.hasClass( "rp-active" ) ){
                $("#pl_sugCal tr").removeClass( "rp-active" );
               // ptr.addClass( "rp-active" );
            }
            
          

            oc_callService( "reserveAppointment", {"suggestion": sugg }, 
                function( resp ){
                    /* alert("reserveAppointment resp:\n" + jstr( resp ) ); */
                    
                    if( true == resp.success ){
                        ele.addClass("rp-active");         
                        pl_selectedSugg = sugg;
                        pl_showSelectedAppInfos( pl_selectedSugg );
                    }
                    else{
                        /* Terminslot konnte nicht mehr reserviert werden*/
                        showInfoMsg("Dieser Terminblock steht leider nicht mehr zur Verfügung.")
                    }    
                    
                }
            );
            
            
            /* alert("pl_selectSugg:\n" + jstr( sugg ) );  */
            
        
        }
        catch( err ){
            console.log("pl_selectSugg ERROR: " + err );
            
        }
        
    }
    
   /* Ausgewählten Termin oben anzeigen */
    function pl_showSelectedAppInfos( sugg ){
        
        /* alert("pl_showSelectedAppInfos: " + jstr( sugg ) ); */
        if( sugg != undefined ){
            $("#pl_curAppInfo").show();
        }
        else{
            $("#pl_curAppInfo").hide();
        }
        
        pl_renderDateLocationSummary( sugg, "pl_selDate", "pl_selLocation" );
        
      
        
    }
        
    
    
    
    
    function pl_renderNoSuggestionsInfo(  ){
        
        $("#pl_appSuggs").html("<h3>Keine Treffer!</h3>");
    }
    
    
    
    

    
    
    /*
     * 
     * BUCHUNGSEINSTELLUNGEN
     * 
     * 
     */    
    function getBookingSettings(){
        
        var bs = {};
        
        /* name zuweiser */
        
        return bs;
    }
    
    
    //        bpDocSJO.put("bookingSettings", JsonUtils.javaxJO2json_smartJSONObject( bookingSettingsJO ) );
    
    
    /*
     * 
     * PATIENTENDATEN
     * 
     * 
     */    
    
    
    
    
    /* Pat Daten prüfen und mappen */ 
    function pl_patDataValid(){
        
        /* alert("pl_patDataValid..."); */
        
        
        var pData = {};
        
        pData.title = $("#pl_ptitle").val().trim();
        
        /* 2022-11-02: Herr o Frau aus Titel NICHT mappen! */
        try{
            if( pData.title != undefined && (pData.title.toLowerCase() == "herr" || pData.title.toLowerCase() == "frau" ) ){
                pData.title = "";
                console.log("removed title");
            }
            
        }
        catch(terr){
            
        }
        
        
        pData.lastname = $("#pl_pname").val().trim();
        pData.firstname = $("#pl_pfname").val().trim();
        pData.sex = $("#pl_pgender").val().trim();
        pData.birthdate = $("#pl_pbdate").val().trim();
        
        /* insurance einmappen */
        pData.insurance = $("#pl_vertragsart").val().trim();
        
        
        pData.phones = [
            {
                "type": "mobile",
                "number": $("#pl_ptel").val().trim()
            }
        ];
        
        
        
        
        pData.email = $("#pl_pemail").val().trim();
        
        var vmsgA = [];
        
        /* Name pflicht */
        pl_valiPatFieldMinLen( pData.lastname, 2, "Bitte füllen Sie den Namen aus.", vmsgA, "pl_lbl_pname" );
        
        /* Vorname pflicht */
        pl_valiPatFieldMinLen( pData.firstname, 2, "Bitte füllen Sie den Vornamen aus.", vmsgA, "pl_lbl_pfname" );
        
        /* Geschlecht pflicht */
        pl_valiPatFieldMinLen( pData.sex, 1, "Bitte wählen Sie ein Geschlecht aus.", vmsgA, "pl_lbl_pgender" );
        
        /* Geburtsdatum pflicht */
        pl_valiPatFieldMinLen( pData.birthdate, 1, "Bitte füllen Sie das Geburtsdatum aus.", vmsgA, "pl_lbl_pbdate" );
        
        
        
        
        
        if( pData.birthdate.length > 1 ){
            if( ! pl_isDateValid( pData.birthdate, "DD.MM.YYYY" ) ){
                vmsgA.push("Bitte geben Sie ein gültiges Geburtsdatum ein (Format TT.MM.JJJJ).");
                addErrorClass( "pl_lbl_pbdate" );
            }
            
        }
        
        
        
        
        
        /* Email pflicht */
        pl_valiPatFieldMinLen( pData.email, 1, "Bitte füllen Sie die E-Mail-Adresse aus.", vmsgA, "pl_lbl_pemail" );
               
        /* Email bestätigen RAUS */
        /*
        var emailConf = $("#pl_pemailConf").val().trim();
        pl_valiPatFieldMinLen( emailConf, 1, "Bitte wiederholen Sie Ihre E-Mail-Adresse.", vmsgA, "pl_lbl_pemailConf" );
              
        if( pData.email != emailConf ){
            vmsgA.push("Die E-Mail-Adressen sind nicht identisch.");
            addErrorClass( "pl_lbl_pemail" );
            addErrorClass( "pl_lbl_pemailConf" );
            
        }
        */
        
        
        /* email sollte halbwegs gültige form haben */
        if( !pl_validateEmail( pData.email ) ){
            vmsgA.push("Bitte geben Sie ein gültige E-Mail-Adresse ein.");
            addErrorClass( "pl_lbl_pemail" );
            addErrorClass( "pl_lbl_pemailConf" );
        }
       
         
        /* Tel pflicht */
        pl_valiPatFieldMinLen( pData.phones[0].number, 1, "Bitte geben Sie eine Telefonnummer ein.", vmsgA, "pl_lbl_ptel" );
        
        /*
        if( pData.name.length < 2 ){
            addErrorClass( "pl_lbl_pname" );
            vmsgA.push("Bitte füllen Sie den Namen aus.");
        }
        else{
            removeErrorClass( "pl_lbl_pname" );
        }
        */
        
        if( vmsgA.length > 0 ){
            /* alert("VALIS:\n" + jstr( vmsgA ) ); */
            
            showValiMsgA( vmsgA );
            
            return false;
        }
        
        pl_curPatData = pData;
        
        
        return true;
        
        
        
    }
    
    function pl_valiPatFieldMinLen( val, minLen, vmsg, vmsgA, errEleId ){
        
        if( val.length < minLen ){
            vmsgA.push( vmsg );
            addErrorClass( errEleId );
        }
        else{
            removeErrorClass( errEleId );
            
        }
        
        
    }
    
    /* Sehr einfacher mailAdr check */
    function pl_validateEmail(email){
        var re = /\S+@\S+\.\S+/;
        return re.test(email);
    }
    
    function pl_isDateValid( inputD, inputFormat ){

        /* alert("pl_isDateValid: " +  inputD ); */

        try{

            /* Strict Parsing aktiviert */
            var tdate =  moment( inputD, inputFormat, true);
            
            /* alert("tdate: " + tdate ); */

            if( isNaN(tdate) || "Invalid date" == tdate ){
                return false;
            }
            else{
                return true;
            }

        } catch( err ){
            /* alert( err ); */
            return false;

        }
    }    

    
    

    /*
     * 
     * ZUSAMMENFASSUNG
     * 
     * 
     */    
    function pl_renderSummary(){
        
        /* alert("pl_renderSummary!"); */
        
        /* Termin */
        pl_renderDateLocationSummary( pl_selectedSugg, "pl_sumDate", "pl_sumLocation" );
        
        
                /* <p id="pl_sumBeforeMinInfo" class="rp-mb-20" style="font-weight: bold;display:none;"></p> */
        pl_insertBeforeMinInfo( "pl_sumBeforeMinInfo", true );        
        
        /* Untersuchungsdaten */
        var ref = $( "#pl_referrer" ).val().trim();
        
        if( ref.length > 0 ){
            $("#pl_sumContRef" ).show();
            $("#pl_sumRef").html( ref );
            
        }
        else{
            $("#pl_sumContRef" ).hide();
        }
        
        var va = $("#pl_vertragsart").val();
        $( "#pl_sumVertragsart" ).html( va );
        
        $( "#pl_sumExaName" ).html( pl_getExaNamesFromSugg( pl_selectedSugg) );
        
        /* persönliche Angaben */
        $( "#pl_sumPatName" ).html( pl_curPatData.lastname + ", " + pl_curPatData.firstname );
        $( "#pl_sumPatBDate" ).html( pl_curPatData.birthdate );
        $( "#pl_sumPatGender" ).html( getGenderLabel( pl_curPatData.sex ) );
        $( "#pl_sumPatTel" ).html( pl_curPatData.phones[0].number );
        $( "#pl_sumPatMail" ).html( pl_curPatData.email );
        
        /* Fragen Zusammenfassung */
        pl_renderHQSummary();
    }
    
    function pl_renderHQSummary(  ) {
        
        
        if( pl_curHQ == undefined ){
            $( "#pl_sumHints" ).html( "" );
            $( "#pl_sumQuestions").html("");
            return;
        }
        
        /* alert("pl_renderHQSummary:\n" + jstr (pl_getHintsAnswers() ) ); */
        
        /* alert("pl_renderHQSummary: pl_curHQ\n" + jstr ( pl_curHQ ) ); */
        
        
        
        var hq = pl_curHQ;
        
        /* Hinweise rendern */
        var hiA = [];
        
        if( hq.hints != undefined ){
            for( var hx in hq.hints ){
                
                var hint = hq.hints[ hx ];
                
                /* Gibt es Mail Text? Dann anzeigen! */
                if( hint.mail != undefined && hint.mail.length > 0 ){
                    hiA.push( "<li class='rp-hint'><p>" );
                    hiA.push( hint.mail );
                    hiA.push( "</p></li>" );
                }
            }
        }
        
        $( "#pl_sumHints" ).html( hiA.join("") );
         
         
         
        var qA = [];
        for( var qx in hq.questions ){

            var quest = hq.questions[ qx ];

            //alert("render summary question:\n" + jstr( quest ) );


            /* Frage beantwortet? */
            if( quest.answer != undefined  ){
                
                /* wenn keine Angabe und NICHT root Quest, dann NICHT anzeigen */
                var hasAns = true;
                if( quest.answer.trim().length == 0 ){ hasAns = false };
                
                if( !hasAns && false == quest.isRootQ ){
                    continue;
                }
                
                
                
                qA.push( "<li class='rp-d-flex rp-mb-15'><p>" );
                qA.push( quest.question );
                qA.push( "</p><span class='rp-bold rp-ml-auto rp-pl-10 rp-mt-auto'>" );
                
                if( quest.answer.trim().length == 0 ){
                    
                    qA.push( "k.A." );
                }
                else{
                    qA.push( quest.answer );
                }
                qA.push( "</span></li>" );
                
                /* gibt es freitext Antwort? */
                try{
                    if( true == quest.allowFreetext && quest.freetext.length > 0 && quest.showFreeTextOptions.includes( quest.answer ) ){
                        var ftQ = "";
                        if( quest.optionInfo[ quest.answer ] != undefined ){
                            ftQ = quest.optionInfo[ quest.answer ];
                        }
                        
                        //alert("Render FreetextAns:\nQuest: " + ftQ + "\nFT: " + quest.freetext );
                        qA.push( "<li class='rp-d-flex rp-mb-5'><p>" );
                        qA.push( ftQ );
                        qA.push( "</p></li><li class='rp-d-flex rp-mb-15'><p class='rp-bold'>Antwort: " );
                        qA.push( quest.freetext );
                        qA.push( "</p></li>" );
                        
                        
                    }
                        
                }
                catch(fterr){}
                

                
                
                
            }
        }        
         
         
        $( "#pl_sumQuestions" ).html( qA.join("") );
                
       
        
        
        
        
    }
    
 
    
    
    
    
    function pl_renderDateLocationSummary( sugg, dateEleId, locEleId ) {
    
            /* Termin */
        var date = ""; /* Mo, 10.03.2021 - 09:30 Uhr */
        var loc = ""; /* 85276 Pfaffenhofen a.d.Ilm */
        if( sugg != undefined ){
            
            date = moment( sugg.start ).format( "ddd, DD.MM.YYYY HH:mm") + " Uhr";
            
            var locData = getLocationData( sugg.location );
            
            loc = locData.zip + " " + locData.city;
            
            /* alert("pl_selectedSugg:\n" + jstr( pl_selectedSugg ) ); */
            
        }
        $("#" + dateEleId ).html( date );
        $("#" + locEleId ).html( loc );
    
    }
        
    function pl_getExaNamesFromSugg( sugg, defVal ){
        if( sugg != undefined && sugg.exaList != undefined ){
            var anfA = [];
            for( var ax in sugg.exaList ){
                
                var anf = sugg.exaList[ ax ].anf;
                if( sugg.exaList[ ax ].modId != undefined ){
                    anf += " [" + sugg.exaList[ ax ].mod_id + "]";
                }
                
                anfA.push( anf );
            }
            return anfA.join( ", " );
        }
        else{
            return "";
            
        }
        
    }





/*
 *  TERMIN BUCHEN
 *  
 */



    function pl_bookApp(){
        
        /* zusätzliche Buchungsdten mitschicken*/
        var bookingData = {
            "financial_class": $( "#pl_vertragsart" ).val(),
            "referrerName": $( "#pl_referrer" ).val(),
            "insurance": $( "#pl_vertragsart" ).val(),
            "diagnose": $( "#pl_sumDiagnose" ).val(),
            "befund": $( "#pl_sumBefund" ).val(),
            "auftrag": $( "#pl_sumAuftrag" ).val()
        };
        
        
        /* Diagnose ist Pflichtfeld */
        if( bookingData.diagnose == undefined || bookingData.diagnose.length == 0 ){
            showValiMsg( "Bitte füllen Sie das Feld 'Diagnose/Verdachtsdiagnose' ihrer Überweisung aus." );   
            $( "#pl_sumDiagnoseLbl" ).addClass("rp-warning");
            $( "#pl_sumDiagnose" ).addClass("rp-val-error");
            return;
        }
        else{
            $( "#pl_sumDiagnoseLbl" ).removeClass("rp-warning");
            $( "#pl_sumDiagnose" ).removeClass("rp-val-error");
        }
        
        
        /* Auftrag ist Pflichtfeld bei einigen  */
        if( bookingData.auftrag == undefined || bookingData.auftrag.length == 0 ){
            showValiMsg( "Bitte füllen Sie das Feld 'Auftrag' ihrer Überweisung aus." );   
            $( "#pl_sumAuftragLbl" ).addClass("rp-warning");
            $( "#pl_sumAuftrag" ).addClass("rp-val-error");
            return;
        }
        else{
            $( "#pl_sumAuftragLbl" ).removeClass("rp-warning");
            $( "#pl_sumAuftrag" ).removeClass("rp-val-error");
        }
                
        
        
        

        var paras = {
            "bookingData": bookingData,
            "suggestion": pl_selectedSugg,
            "patient": pl_curPatData,
            "hintsAnswers": pl_getHintsAnswers()
        };
        
        /* Hinweis vorher erschienen auch per mail */
        
        try{
            

            var beforeMin = 0;
            var etn = getSelectedEtn( "" );
            if( etn != undefined ) {beforeMin = etn.beforeMin;}

            if( beforeMin > 0 ){
                
                paras.hintsAnswers.hints.unshift(
                  
                    {
                      "gui": "Bitte erscheinen Sie für diese Untersuchung " + beforeMin.toString() + " Minuten vorher in der Praxis.",
                      "mail":"<h1>Bitte erscheinen Sie für diese Untersuchung " + beforeMin.toString() + " Minuten vorher in der Praxis.</h1>"
                    }                        
                        
                );
            }
            
        }
        catch( befErr ){
            
            
        }
        /* console.log("pl_bookApp: paras:\n" + jstr( paras ) ); */
        
        oc_callService( "bookAppointment", paras,
            function( resp ){
               /* console.log("bookAppointment RESP:\n" + jstr( resp ) ); */
               
               /* Buchung erfolgreich? */
               if( true == resp.success ){
                   
                   /* state leeren! */
                   reinitState();
                   /* umleiten auf bookingsuccess.html */
                   window.location.replace("./bookingsuccess.html");
                   
               }
               else{
                   /* Buchung NICHT erfolgreich! Fehlermeldung anzeigen */
                   var wmsg = "Die Terminbuchung konnte aus technischen Gründen NICHT vorgenommen werden!";
                   if( resp.errCode != undefined ){
                       wmsg + " [Fehler: " + resp.errCode + "]";
                       
                   }
                   
                   showWarnMsg( wmsg );
                   
               }
               
               
            }
            
        );
        

    }





    function openNav() {
      document.getElementById("sidenav").style.width = "300px";
    }

    function closeNav() {
      document.getElementById("sidenav").style.width = "0";
    }
    
    if( true === TESTMODE ){
        pl_insertTestData();
    }    
        
        
    
    
    
    

</script>

</body>
</html>


